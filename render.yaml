# Configuração de Deploy para Render
# Este arquivo define dois serviços: um para o backend (Web Service) e um para o frontend (Static Site).

services:
  # 1. Serviço Web (Backend)
  - type: web
    name: barbearia-criatech-api
    env: node
    # O comando de build executa o build do frontend (vite build) e do backend (esbuild)
    buildCommand: pnpm install && pnpm build
    # O comando de inicialização executa o servidor Node.js
    startCommand: pnpm start
    # O diretório raiz do projeto é onde o render.yaml está
    rootDir: .
    # Variáveis de ambiente
    envVars:
      - key: DATABASE_URL
        # O Render permite referenciar o banco de dados por nome de serviço, mas aqui usaremos a URL completa fornecida
        # É altamente recomendável que você defina esta variável de ambiente diretamente no painel do Render
        # com o valor secreto: postgresql://cria_tech_db_user:jmXS2CNYNXvSEoVm72llbMOYyyqV5g1w@dpg-d4pkt763jp1c7392m5ug-a.virginia-postgres.render.com/cria_tech_db?sslmode=require
        value: postgresql://cria_tech_db_user:jmXS2CNYNXvSEoVm72llbMOYyyqV5g1w@dpg-d4pkt763jp1c7392m5ug-a.virginia-postgres.render.com/cria_tech_db?sslmode=require
      - key: NODE_ENV
        value: production
      # O Render injeta a porta automaticamente na variável PORT
      - key: PORT
        value: 10000 # Valor padrão, será sobrescrito pelo Render

      - key: S3_ENDPOINT
        value: SEU_S3_ENDPOINT # Substitua pelo valor real no Render
      - key: S3_ACCESS_KEY_ID
        value: SEU_S3_ACCESS_KEY_ID # Substitua pelo valor real no Render
      - key: S3_SECRET_ACCESS_KEY
        value: SEU_S3_SECRET_ACCESS_KEY # Substitua pelo valor real no Render
      - key: S3_BUCKET_NAME
        value: SEU_S3_BUCKET_NAME # Substitua pelo valor real no Render
      - key: S3_REGION
        value: SEU_S3_REGION # Substitua pelo valor real no Render
    # O Render expõe a porta 10000 por padrão
    port: 10000
    # O Render usa o comando de inicialização para determinar se o serviço está pronto
    healthCheckPath: /api/trpc/health

  # 2. Serviço Estático (Frontend)
  - type: static
    name: barbearia-criatech-web
    # O buildCommand já foi executado no serviço web, mas é bom ter aqui para garantir
    # No entanto, como o build do frontend está no buildCommand do serviço web,
    # vamos apenas apontar para o diretório de saída.
    # O Render precisa que o build seja executado para o Static Site, então vamos duplicar o comando de build
    # e garantir que o diretório de saída seja o correto.
    buildCommand: pnpm install && pnpm build
    # O diretório de publicação é o diretório onde o Vite coloca os arquivos estáticos
    publishPath: dist/public
    # O serviço estático precisa saber onde encontrar a API
    envVars:
      - key: VITE_API_URL
        # O Render injeta a URL do serviço web na variável de ambiente
        # Substitua pelo nome do seu serviço web no Render
        value: https://barbearia-criatech-api.onrender.com # Substitua pelo URL real do seu serviço web no Render
